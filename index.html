<!DOCTYPE HTML>
<html>
<head>
    <!-- support for mobile touch devices -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1, minimal-ui">
    <link href="bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="cornerstone.min.css" rel="stylesheet">
</head>
<style>

    /* prevent 'bounce' in scrolling */
    html {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    body {
      height: 100%;
      width: 100%;
      overflow: auto;
    }

    .hidden {
        display: none;
    }

    /* images are displayed in viewports */
    .viewport {
        width:100%;
        height:100%;
        top:0px;
        left:0px;
        position:absolute
    }

    .overlay {
        position: absolute;
        color: #e4ad00;
    }

    .imageViewer {
    }

    .myNav {
        margin: 0;
        border:0;
    }

    .viewportWrapper {

    }
    .renderTime {}
    .fps {}

    .csthumbnail {
        color: white;
        background-color:black;
        width:100px;
        height:100px;
        border: 0px;
        padding: 0px;
    }

    .viewer {
        position: absolute;
        width: 100%;
        left: 110px;
    }

    .thumbnailSelector {
        width:106px;
        float:left;
        margin-left:0px;
    }
    body, html {height:100%}

    #wrap {height:100%}

    .studyContainer {
        margin-top: 2px;
        margin-left:0px;
        margin-right:0px;
        padding: 0px;
    }
    .container {
    }

    .thumbnails {
        margin:0px;
        margin-bottom: 0px;
        overflow-y:scroll;
        overflow-x:hidden;
    }
    .studyRow {
        margin-left: 0px;
        margin-rigth: 0px;
        height:100%;
    }
    .row {
        margin:0;
    }

    a.list-group-item {
        background-color: black;
        padding: 2px;
    }
    a.list-group-item.active, a.list-group-item.active:hover, a.list-group-item.active:focus {
        background-color: #424242;
        border-color: #4e4e4e;
    }
    .nav-tabs>li.active>a, .nav-tabs>li.active>a:hover, .nav-tabs>li.active>a:focus {
        background-color: #424242;
        border-color: #4e4e4e;
    }

</style>
<body>
<div id="wrap">
    <nav class="myNav navbar navbar-default" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="https://github.com/chafey/cornerstone">Cornerstone</a>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li><a id="help" href="#" class="button hidden-xs">Help</a></li>
                <li><a id="about" href="#" class="button hidden-xs">About</a></li>
            </ul>

        </div>
    </nav>
    <div class='main'>
        <ul id="tabs" class="nav nav-tabs" >
            <li class="active"><a href="#studyList" data-toggle="tab">Study List</a></li>
        </ul>

        <div id="tabContent" class="tab-content">
            <div id="studyList" class="tab-pane active">
                <div class="row">
                    <table  class="col-md-12 table table-striped">
                        <thead>
                        <tr>
                            <th>Patient Name</th>
                            <th>Patient ID</th>
                            <th>Study Date</th>
                            <th>Modality</th>
                            <th>Study Description</th>
                            <th># Images</th>
                        </tr>
                        </thead>
                        <tbody id="studyListData">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="studyViewerTemplate" class="tab-pane active hidden" style="height:100%">
            <div class="studyContainer" style="height:100%">
                <div class="studyRow row" style="height:100%">
                    <div class="thumbnailSelector">
                        <div class="thumbnails list-group">
                        </div>
                    </div>
                    <div class="viewer">
                        <div class="text-center" >
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="WW/WC"><span class="fa fa-sun-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Invert"><span class="fa fa-adjust"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Zoom"><span class="fa fa-search"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Pan"><span class="fa fa-arrows"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Stack Scroll"><span class="fa fa-bars"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Length Measurement"><span class="fa fa-arrows-v"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Pixel Probe"><span class="fa fa-dot-circle-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Elliptical ROI"><span class="fa fa-circle-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Rectangle ROI"><span class="fa fa-square-o"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Play Clip"><span class="fa fa-play"></span></button>
                                <button type="button" class="btn btn-sm btn-default" data-container='body' data-toggle="tooltip" data-placement="bottom" title="Stop Clip"><span class="fa fa-stop"></span></button>
                            </div>
                        </div>
                        <div class="imageViewer">
                            <div class="viewportWrapper" style="width:100%;height:100%;position:relative;color: white;display:inline-block;background-color:black;"
                                 oncontextmenu="return false"
                                 class='cornerstone-enabled-image'
                                 unselectable='on'
                                 onselectstart='return false;'
                                 onmousedown='return false;'>
                                <div class="viewport">
                                </div>
                                <div class="overlay" style="top:0px; left:0px">
                                    <div>Patient Name</div>
                                    <div>Patient Id</div>
                                </div>
                                <div class="overlay" style="top:0px; right:0px">
                                    <div>Study Description</div>
                                    <div>Study Date</div>
                                </div>

                                <div class="overlay" style="bottom:0px; left:0px">
                                    <div class="fps">FPS:</div>
                                    <div class="renderTime">Render Time:</div>
                                    <div class="currentImageAndTotalImages">Image #:</div>
                                </div>
                                <div class="overlay" style="bottom:0px; right:0px">
                                    <div>Zoom:</div>
                                    <div>WW/WC:</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Help</h4>
            </div>
            <div class="modal-body">
                <ol>
                    <li>Select a study in the study list to view its images, a new tab will be created for each study.</li>
                    <li>Interact with the image using your mouse: left click drag - ww/wl, middle click drag - pan, right click drag - zoom, mouse wheel - scroll through stack</li>
                    <li>Select another series to display by left click the series list on the left</li>
                    <li>Select another tool to use with the left mouse button by selecting the tool button</li>
                </ol>
                <br>
                This demo requires a HTLM5 browser, Google Chrome is recommended.
                <br>
             </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="aboutModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">About</h4>
            </div>
            <div class="modal-body">
                <br>
                This demo is based on the Cornerstone open source project.  All 2D image rendering is done on the client side
                side using HTML5 and JavaScript.  DICOM P10 Instances are retrieved via WADO, parsed and displayed by the viewer -
                the server side performs no processing.
                <br>
                <a href="https://github.com/chafey/cornerstone" target="_blank">Click here</a> to learn more about cornerstone
                <br>
                <a href="architecture.html" target="_blank">Click here</a> to read about the architecture
                <br>
                <br>
                <br>
                In this demo data is pulled from an instance of <a href="https://github.com/pieper/Chronicle">Chronicle</a>.
                <br>
                <br>
                The data is from <a href="http://www.cancerimagingarchive.net">TCIA</a>.
                <br>
                <br>
                The project is related to <a href="http://qiicr.org">QIICR</a>.

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script src="jquery-2.1.0.min.js"></script>

<!-- include the hammer.js library for touch gestures-->
<script src="jquery.hammer-full.js"></script>

<script src="bootstrap.min.js" ></script>

<!-- include the cornerstone library -->
<!-- <script src="cornerstone.min.js"></script> -->
<script src="cornerstone.js"></script>

<!-- include the cornerstone library -->
<script src="cornerstoneMath.min.js"></script>

<!-- include the cornerstone tools library -->
<script src="cornerstoneTools.js"></script>

<!-- include the cornerstoneWADOImageLoader library -->
<script src="cornerstoneWADOImageLoader.min.js"></script>

<script src="cornerstoneWebImageLoader.min.js"></script>

<!-- include the dicomParser library -->
<script src="dicomParser.min.js"></script>


<!-- chronicle: add couch support via pouchdb-->
<script src="pouchdb-3.3.1.min.js"></script>

<!-- chronicle: add http loader -->
<script src="cornerstoneHTTPDICOMImageLoader.js"></script>

    <script>

    var chURLPrefix = "http://common.bwh.harvard.edu:5984";
    var chDatabase = "chronicle";
    var chronicle = new PouchDB(chURLPrefix+'/'+chDatabase);

    $('#tabs a').click(function (e) {
        e.preventDefault()
        $(this).tab('show')
    })

    var stacks = [];
    var currentStackIndex = 0;
    var seriesIndex = 0;
    var seriesList = undefined;
    var firstImageFetched = undefined;

    function chronicleAddStackToSeriesList(studyViewer, stack) {
      var seriesEntry = '<a class="list-group-item" + ' +
                            'oncontextmenu="return false"' +
                            'unselectable="on"' +
                            'onselectstart="return false;"' +
                            'onmousedown="return false;">' +
                            '<div class="csthumbnail"' +
                                  'oncontextmenu="return false"' +
                                  'unselectable="on"' +
                                  'onselectstart="return false;"' +
                                  'onmousedown="return false;"></div>' +
                            "<div class='text-center small'>" + stack.seriesDescription + '</div></a>';

      var seriesElement = $(seriesEntry).appendTo(seriesList);
      var thumbnail = $(seriesElement).find('div')[0];
      cornerstone.enable(thumbnail);
      cornerstone.loadAndCacheImage(stacks[stack.seriesIndex].imageIds[0]).then(function(image) {
          if(stack.seriesIndex === 0) {
              $(seriesElement).addClass('active');
          }
          cornerstone.displayImage(thumbnail, image);
      });

      $(seriesElement).on('click touchstart', function () {selectSeries(studyViewer, seriesElement, stack);});
    };

    // given a key to a series, fill a list of instances
    function chronicleLoadSeries(studyViewer, key) {
      var stack = {
          seriesDescription: key[2][1],
          stackId : seriesIndex,
          imageIds: [], // actually URLs
          seriesIndex : seriesIndex,
          currentImageIdIndex: 0,
          frameRate: 1,
          instanceURLsByImageNumber: {} // for sorting imageIds
      };
      seriesIndex++;
      stacks.push(stack);

      // TODO: populate the series selector
      seriesList = $(studyViewer).find('.thumbnails')[0];

      // chronicle
      seriesUID = key[2][2];
      chronicle.query("instances/seriesInstances", {
        startkey : seriesUID,
        endkey : seriesUID + '\u9999',
        stale : 'update_after',
        reduce : false,
      }).then(function(data) {
        console.log('then data is ', data);
        $.each(data.rows, function(index,row) {
          var instanceUID = row.value[1];
          var instanceURL = chURLPrefix + '/' + chDatabase + '/' + instanceUID + '/object.dcm';
          //stack.imageId.push(instanceURL);
          if (!firstImageFetched) {
            //instanceURL = 'http://common:5984/chronicle/1.3.6.1.4.1.32722.99.99.115511490271174834109077870583423555935/object.dcm'
            // TODO: fix this so it happens once per loaded tab
            firstImageFetched = instanceURL;
            enableImageElement(studyViewer, instanceURL);
          }
          stack.imageIds.push(instanceURL);
          // fetch the instance number and sort the URLs accordingly
          // -- since this is async we sort every time a new one arrives
          //    probably not a big overhead, but if this is slow, we could
          //    keep a list of pending requests and then sort when it's done.
          //    (but there's a risk it would never be sorted if something hangs)
          chronicle.get(instanceUID).then(function(doc) {
            var instanceNumberTag = "00200013";
            var instanceNumber = Number(doc.dataset[instanceNumberTag].Value);
            stack.instanceURLsByImageNumber[instanceNumber] = instanceURL;
            var instanceNumbers = Object.keys(stack.instanceURLsByImageNumber);
            instanceNumbers.sort(function(a,b){return a-b});
            var newImageIds = [];
            $.each(instanceNumbers, function(index,instanceNumber) {
              newImageIds.push(stack.instanceURLsByImageNumber[instanceNumber]);
            });
            stack.imageIds = newImageIds;
          });
        });
        chronicleAddStackToSeriesList(studyViewer, stack);
      });
    };

    // for a study key, request a set of series
    function chronicleLoadStudy(studyViewer, key) {
      var endkey = key.slice(0); // shallow copy
      endkey.push({});
      chronicle.query("instances/context", {
        startkey: key,
        endkey: endkey,
        reduce : true,
        stale : 'update_after',
        group_level : 3,
      }).then(function(data) {
        $.each(data.rows, function(index,row) {
          chronicleLoadSeries(studyViewer, row.key);
        });
      });

      data = {
        patientName : key[0][1],
        patientId : key[0][1],
        studyDescription : key[1][0],
        studyDate : "TBD",
      };

      // resize the parent div of the viewport to fit the screen
      var imageViewer = $(studyViewer).find('.imageViewer')[0];
      var viewportWrapper = $(imageViewer).find('.viewportWrapper')[0];
      var parentDiv = $(studyViewer).find('.viewer')[0];
      viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
      viewportWrapper.style.height= (window.innerHeight - 150) + "px";

      var studyRow = $(studyViewer).find('.studyRow')[0];
      var width = $(studyRow).width();
      $(parentDiv).width(width - 170);
      viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
      viewportWrapper.style.height= (window.innerHeight - 150) + "px";

    }

    function enableImageElement(studyViewer, imageURL) {

      var element = $(studyViewer).find('.viewport')[0];

      function onNewImage(e) {
        // image enable the dicomImage element and activate a few tools
        var childDivs = $(studyViewer).find('.overlay');
        var topLeft = $(childDivs[0]).find('div');
        $(topLeft[0]).text(data.patientName);
        $(topLeft[1]).text(data.patientId);
        var topRight= $(childDivs[1]).find('div');
        $(topRight[0]).text(data.studyDescription);
        $(topRight[1]).text(data.studyDate);
        var bottomLeft = $(childDivs[2]).find('div');
        var bottomRight = $(childDivs[3]).find('div');


        // if we are currently playing a clip then update the FPS
        var playClipToolData = cornerstoneTools.getToolState(element, 'playClip');
        if(playClipToolData !== undefined && playClipToolData.data.length > 0 && playClipToolData.data[0].intervalId !== undefined && e.detail.frameRate !== undefined) {
            $(bottomLeft[0]).text("FPS: " + Math.round(e.detail.frameRate));
        } else {
            if($(bottomLeft[0]).text().length > 0) {
                $(bottomLeft[0]).text("");
            }
        }
        $(bottomLeft[2]).text("Image #" + (stacks[currentStackIndex].currentImageIdIndex + 1) + "/" + stacks[currentStackIndex].imageIds.length);
      }
      element.addEventListener("CornerstoneNewImage", onNewImage, false);

      function onImageRendered(e) {
          $(bottomRight[0]).text("Zoom:" + e.detail.viewport.scale.toFixed(2));
          $(bottomRight[1]).text("WW/WL:" + Math.round(e.detail.viewport.voi.windowWidth) + "/" + Math.round(e.detail.viewport.voi.windowCenter));
          $(bottomLeft[1]).text("Render Time:" + e.detail.renderTimeInMs + " ms");
      }
      element.addEventListener("CornerstoneImageRendered", onImageRendered, false);

      // image enable the dicomImage element
      cornerstone.enable(element);
      var promise = cornerstone.loadAndCacheImage(imageURL);
      promise.then(function(image) {
          cornerstone.displayImage(element, image);

          cornerstoneTools.mouseInput.enable(element);
          cornerstoneTools.mouseWheelInput.enable(element);
          cornerstoneTools.touchInput.enable(element);

          // Enable all tools we want to use with this element
          cornerstoneTools.wwwc.activate(element, 1); // ww/wc is the default tool for left mouse button
          cornerstoneTools.pan.activate(element, 2); // pan is the default tool for middle mouse button
          cornerstoneTools.zoom.activate(element, 4); // zoom is the default tool for right mouse button
          cornerstoneTools.probe.enable(element);
          cornerstoneTools.length.enable(element);
          cornerstoneTools.ellipticalRoi.enable(element);
          cornerstoneTools.rectangleRoi.enable(element);
          cornerstoneTools.wwwcTouchDrag.activate(element);
          cornerstoneTools.zoomTouchPinch.activate(element);


          // stack tools
          cornerstoneTools.addStackStateManager(element, ['playClip']);
          cornerstoneTools.addToolState(element, 'stack', stacks[0]);
          cornerstoneTools.stackScrollWheel.activate(element);
          cornerstoneTools.stackPrefetch.enable(element);


          function disableAllTools()
          {
              cornerstoneTools.wwwc.disable(element);
              cornerstoneTools.pan.activate(element, 2); // 2 is middle mouse button
              cornerstoneTools.zoom.activate(element, 4); // 4 is right mouse button
              cornerstoneTools.probe.deactivate(element, 1);
              cornerstoneTools.length.deactivate(element, 1);
              cornerstoneTools.ellipticalRoi.deactivate(element, 1);
              cornerstoneTools.rectangleRoi.deactivate(element, 1);
              cornerstoneTools.stackScroll.deactivate(element, 1);
              cornerstoneTools.wwwcTouchDrag.deactivate(element);
              cornerstoneTools.zoomTouchDrag.deactivate(element);
              cornerstoneTools.panTouchDrag.deactivate(element);
              cornerstoneTools.stackScrollTouchDrag.deactivate(element);
          }

          var buttons = $(studyViewer).find('button');
          // Tool button event handlers that set the new active tool
          $(buttons[0]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.wwwc.activate(element, 1);
              cornerstoneTools.wwwcTouchDrag.activate(element);
          });
          $(buttons[1]).on('click touchstart',function() {
              disableAllTools();
              var viewport = cornerstone.getViewport(element);
              if(viewport.invert === true) {
                  viewport.invert = false;
              }
              else {
                  viewport.invert = true;
              }
              cornerstone.setViewport(element, viewport);
          });
          $(buttons[2]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.zoom.activate(element, 5); // 5 is right mouse button and left mouse button
              cornerstoneTools.zoomTouchDrag.activate(element);
          });
          $(buttons[3]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.pan.activate(element, 3); // 3 is middle mouse button and left mouse button
              cornerstoneTools.panTouchDrag.activate(element);
          });
          $(buttons[4]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.stackScroll.activate(element, 1);
              cornerstoneTools.stackScrollTouchDrag.activate(element);
          });
          $(buttons[5]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.length.activate(element, 1);
          });
          $(buttons[6]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.probe.activate(element, 1);
          });
          $(buttons[7]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.ellipticalRoi.activate(element, 1);
          });
          $(buttons[8]).on('click touchstart',function() {
              disableAllTools();
              cornerstoneTools.rectangleRoi.activate(element, 1);
          });
          $(buttons[9]).on('click touchstart',function() {
              var frameRate = stacks[currentStackIndex].frameRate;
              if(frameRate === undefined) {
                  frameRate = 10;
              }
              cornerstoneTools.playClip(element, 31);
          });
          $(buttons[10]).on('click touchstart',function() {
              cornerstoneTools.stopClip(element);
          });
          $(buttons[0]).tooltip();
          $(buttons[1]).tooltip();
          $(buttons[2]).tooltip();
          $(buttons[3]).tooltip();
          $(buttons[4]).tooltip();
          $(buttons[5]).tooltip();
          $(buttons[6]).tooltip();
          $(buttons[7]).tooltip();
          $(buttons[8]).tooltip();
          $(buttons[9]).tooltip();

          function resizeStudyViewer() {
              var parentDiv = $(studyViewer).find('.viewer')[0];
              var studyRow = $(studyViewer).find('.studyRow')[0];
              var imageViewer = $(studyViewer).find('.imageViewer')[0];
              var viewportWrapper = $(imageViewer).find('.viewportWrapper')[0];
              var height = $(studyRow).height();
              var width = $(studyRow).width();
              $(seriesList).height(height - 40);
              $(parentDiv).width(width - 170);
              viewportWrapper.style.width = (parentDiv.style.width - 10) + "px";
              viewportWrapper.style.height= (window.innerHeight - 150) + "px";
              cornerstone.resize(element, true);
          }

          $(window).resize(function() {
              resizeStudyViewer();
          });
          resizeStudyViewer();

      });
    }

    function selectSeries (studyViewer, seriesElement, stack) {
      // make this series visible
      var activeThumbnails = $(seriesList).find('a').each(function() {
          $(this).removeClass('active');
      });
      $(seriesElement).addClass('active');

      var element = $(studyViewer).find('.viewport')[0];
      cornerstoneTools.stopClip(element);
      cornerstoneTools.stackScroll.disable(element);
      cornerstoneTools.stackScroll.enable(element, stacks[stack.seriesIndex], 0);
      cornerstone.loadAndCacheImage(stacks[stack.seriesIndex].imageIds[0]).then(function(image) {
          var defViewport = cornerstone.getDefaultViewport(element, image);
          currentStackIndex = stack.seriesIndex;
          cornerstone.displayImage(element, image, defViewport);
          cornerstone.fitToWindow(element);
          var stackState = cornerstoneTools.getToolState(element, 'stack');
          stackState.data[0] = stacks[stack.seriesIndex];
          stackState.data[0].currentImageIdIndex = 0;
          cornerstoneTools.stackPrefetch.enable(element);

          var childDivs = $(studyViewer).find('.overlay');
          var topLeft = $(childDivs[0]).find('div');
          var topRight= $(childDivs[1]).find('div');
          var bottomLeft = $(childDivs[2]).find('div');
          var bottomRight = $(childDivs[3]).find('div');
          $(bottomLeft[1]).text("# Images: " + stacks[stack.seriesIndex].imageIds.length);
      });
    }

    function resizeMain() {
        var height = $(window).height();
        $('#main').height(height - 50);
        $('#tabContent').height(height - 50 -42);
    }

    $(window).resize(function() {
        resizeMain();
    });
    resizeMain();

    // chronicle
    chronicle.query("instances/context", {
      reduce : true,
      stale : 'update_after',
      /*startkey : [['UnspecifiedInstitution','QIN-PROSTATE-01']],*/ // only show the prostates - they basically work
      group_level : 2,
    }).then(function(data) {
      $.each(data.rows, function(index,row) {
        var id = row.id;

        //createSeriesBlock(imageURL);

        var institution = row.key[0][0];
        var patientUID = String(row.key[0]);
        var patientID = row.key[0][1];
        var studyDescription = row.key[1][0];

        var instanceCount = row.value;

        var studyRow = '<tr><td>' +
                patientID + '</td><td>' +
                patientUID + '</td><td>' +
                "study.studyDate" + '</td><td>' +
                "study.modality" + '</td><td>' +
                studyDescription + '</td><td>' +
                instanceCount + '</td><td>' +
                '</tr>';
        var studyRowElement = $(studyRow).appendTo('#studyListData');
        $(studyRowElement).click(function() {
          // Add new tab for this study and switch to it
          var studyTab = '<li><a href="#x' + patientID + '" data-toggle="tab">' + patientID + '</a></li>';
          $('#tabs').append(studyTab);

          // add tab content by making a copy of the studyViewerTemplate element
          var studyViewerCopy = $('#studyViewerTemplate').clone();
          studyViewerCopy.attr("id", 'x' + patientID);
          studyViewerCopy.removeClass('hidden');
          studyViewerCopy.appendTo('#tabContent');

          // show the new tab - which will be the last one since it was just added
          $('#tabs a:last').tab('show');

          $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
              $(window).trigger('resize');
          });

          // Now load the study.json
          chronicleLoadStudy(studyViewerCopy, row.key);
        });
      });
    });

    $("#help").click(function() {
        $("#helpModal").modal();
    });

    $("#about").click(function() {
        $("#aboutModal").modal();
    });


    // prevent scrolling on ios
    document.body.addEventListener('touchmove', function(e){ e.preventDefault(); });


</script>

</body>
</html>
